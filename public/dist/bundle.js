"use strict";var postchooser=angular.module("postchooser",["firebase"]);postchooser.filter("postFilter",function($location){return function(input){var filtered={};var path=$location.path();angular.forEach(input,function(post,id){if(path==="/unfiled"){if(!post.marked&&!post.hidden){filtered[id]=post}}else if(path==="/marked"){if(post.marked){filtered[id]=post}}else if(path==="/hidden"){if(post.hidden){filtered[id]=post}}else{filtered[id]=post}});return filtered}});"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};postchooser.controller("PostCtrl",function PostCtrl($scope,$location,$firebaseAuth,$firebaseArray,$firebaseObject,$filter){var fireRefMeta=firebase.database().ref("posts/meta");$scope.posts=$firebaseArray(fireRefMeta);$scope.$watch("posts",function(){var total=0;var remaining=0;angular.forEach($scope.posts,function(post){if(!post||!post.title){return}total++;if(post.marked===false&&post.hidden===false){remaining++}post.createdAtDate=new Date(post.createdAt*1e3);var lowerCaseTitle=post.title.toLowerCase();if(lowerCaseTitle.indexOf("testimon")>-1||lowerCaseTitle.indexOf("clicking")>-1||lowerCaseTitle.indexOf("clicked")>-1){post.highlighted=true}});$scope.totalCount=total;$scope.remainingCount=remaining;$scope.markedCount=total-remaining},true);$scope.signInWithGoogle=function(){var provider=new firebase.auth.GoogleAuthProvider;firebase.auth().signInWithPopup(provider).then(function(authData){}).catch(function(err){console.error("Authentication error",err)})};$scope.signOut=function(){firebase.auth().signOut().then(function(){$scope.user=null}).catch(function(err){console.error("Signout error",err)})};firebase.auth().onAuthStateChanged(function(user){if(user){console.log("signed in",firebase.auth().currentUser);$scope.user=user}else{$scope.user=null}$scope.$apply()});$scope.importUrlError=function(){var _ref=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{type:""},type=_ref.type;switch(type){case"DUPLICATE":window.alert("Post is already in the list");break;default:window.alert("URL is not a valid Reddit post url")}};$scope.addPostFromUrl=function(){if(!$scope.newPostUrl)return;var redditUrlRegex=/https:\/\/(?:www\.)?reddit\.com\/[-a-zA-Z0-9@:%._\+~#=\/]{2,256}\b([-a-zA-Z0-9@:%_\+.~#?&\/\/=]*)/;var newPostUrl=$scope.newPostUrl;if(newPostUrl.lastIndexOf("/")===newPostUrl.length-1){newPostUrl=newPostUrl.slice(0,-1)}else{newPostUrl=newPostUrl}if(redditUrlRegex.test(newPostUrl)){var urlParts=newPostUrl.split("/");if(urlParts.length>=6){var _ret=function(){var newPostId=urlParts[urlParts.length-2];var duplicatePost=$scope.posts.find(function(post){return post.id===newPostId});if(duplicatePost){$scope.importUrlError({type:"DUPLICATE"});$scope.newPostUrl="";return{v:void 0}}}();if((typeof _ret==="undefined"?"undefined":_typeof(_ret))==="object")return _ret.v}else{return $scope.importUrlError()}var queryStringStart=newPostUrl.indexOf("?");if(queryStringStart>-1){newPostUrl=newPostUrl.slice(0,queryStringStart)}fetch(newPostUrl+".json").then(function(res){res.json().then(function(json){var postData=json[0].data.children[0].data;var title=postData.title,id=postData.id,author=postData.author,score=postData.score,created_utc=postData.created_utc,url=postData.url,selftext=postData.selftext;var newPost={id:id,title:title,author:author,score:score,url:url,createdAt:created_utc,importedByUrl:true};$scope.posts.$add(newPost);$scope.postsContent[id]=selftext;$scope.newPostUrl="";$scope.$apply()})}).catch(function(err){console.error("Error fetching reddit data",err)})}else{return $scope.importUrlError()}};$scope.importNewPosts=function(){window.fetchNewPostsAndSave("MakingSense").then(function(newPosts){newPosts.forEach(function(post){$scope.posts.$add(post)})}).catch(function(err){console.error(err)})};$scope.toggle=function(post,key){post[key]=!post[key];$scope.posts.$save(post)};$scope.showPreview={};$scope.postsContent={};$scope.togglePreview=function(postId){var show=!$scope.showPreview[postId];if(show===true){if($scope.postsContent[postId]){$scope.showPreview[postId]=true}else{var post=$scope.posts.find(function(_ref2){var id=_ref2.id;return id===postId});var postUrl=post.url;fetch(postUrl+".json").then(function(res){res.json().then(function(json){var postData=json[0].data.children[0].data;var selftext=postData.selftext;$scope.postsContent[postId]=selftext;$scope.showPreview[postId]=true;$scope.$apply()})}).catch(function(err){console.error("Error fetching reddit data",err)})}}else{$scope.showPreview[postId]=false}};$scope.removePost=function(post){$scope.posts.$remove(post)};$scope.clearCompletedPosts=function(){$scope.posts.forEach(function(post){if(post.marked){$scope.removePost(post)}})};$scope.searchAllAuthorPosts=function(author){$scope.setSearchQuery(author);$location.path("/")};$scope.setSearchQuery=function(query){$scope.searchQuery=query};$scope.resetSearchQuery=function(e){$location.path("/unfiled");$scope.searchQuery="";$scope.resetCheckboxes()};$scope.search=function(post){return angular.lowercase(post.title).indexOf(angular.lowercase($scope.searchQuery)||"")!==-1||angular.lowercase(post.author).indexOf(angular.lowercase($scope.searchQuery)||"")!==-1};function filterPosts(posts){var filteredPosts=posts.filter(function(post){return $scope.search(post)});filteredPosts=$filter("postFilter",$location)(filteredPosts);return filteredPosts}$scope.resetCheckboxes=function(){$scope.allMarked=false;$scope.allHidden=false};$scope.markAll=function(){$scope.allMarked=!$scope.allMarked;var filteredPosts=filterPosts($scope.posts);console.log("Set marked to:",$scope.allMarked,Object.keys(filteredPosts).length);angular.forEach(filteredPosts,function(post){post.marked=$scope.allMarked;$scope.posts.$save(post)})};$scope.hideAll=function(){$scope.allHidden=!$scope.allHidden;var filteredPosts=filterPosts($scope.posts);console.log("Set hidden to:",$scope.allHidden,Object.keys(filteredPosts).length);angular.forEach(filteredPosts,function(post){post.hidden=$scope.allHidden;$scope.posts.$save(post)})};if($location.path()===""){$location.path("/")}$scope.location=$location});"use strict";postchooser.directive("ngRightClick",function($parse){return function(scope,element,attrs){var fn=$parse(attrs.ngRightClick);element.bind("contextmenu",function(event){scope.$apply(function(){event.preventDefault();fn(scope,{$event:event})})})}});"use strict";postchooser.directive("postBlur",function(){return function(scope,elem,attrs){elem.bind("blur",function(){scope.$apply(attrs.postBlur)});scope.$on("$destroy",function(){elem.unbind("blur")})}});"use strict";postchooser.directive("postEscape",function(){var ESCAPE_KEY=27;return function(scope,elem,attrs){elem.bind("keydown",function(event){if(event.keyCode===ESCAPE_KEY){scope.$apply(attrs.postEscape)}});scope.$on("$destroy",function(){elem.unbind("keydown")})}});"use strict";postchooser.directive("postFocus",function postFocus($timeout){return function(scope,elem,attrs){scope.$watch(attrs.postFocus,function(newVal){if(newVal){$timeout(function(){elem[0].focus()},0,false)}})}});"use strict";function apply(func,thisArg,args){switch(args.length){case 0:return func.call(thisArg);case 1:return func.call(thisArg,args[0]);case 2:return func.call(thisArg,args[0],args[1]);case 3:return func.call(thisArg,args[0],args[1],args[2])}return func.apply(thisArg,args)}function onlyOnce(fn){return function(){if(fn===null)throw new Error("Callback was already called.");var callFn=fn;fn=null;callFn.apply(this,arguments)}}function overRest$1(func,start,transform){start=Math.max(start===undefined?func.length-1:start,0);return function(){var args=arguments,index=-1,length=Math.max(args.length-start,0),array=Array(length);while(++index<length){array[index]=args[start+index]}index=-1;var otherArgs=Array(start+1);while(++index<start){otherArgs[index]=args[index]}otherArgs[start]=transform(array);return apply(func,this,otherArgs)}}function rest(func,start){return overRest$1(func,start,function(val){return val})}function whilst(test,iteratee,callback){callback=onlyOnce(callback||noop);if(!test())return callback(null);var next=rest(function(err,args){if(err)return callback(err);if(test())return iteratee(next);callback.apply(null,[null].concat(args))});iteratee(next)}var index={whilst:whilst};window.async=index;"use strict";window.fetchNewPostsAndSave=function(subreddit){return new Promise(function(resolve,reject){var fireRef=firebase.database().ref();fireRef.once("value").then(function(snapshot){var finalPostId=void 0;var posts=snapshot.child("posts/meta").val();var index=0;var newestCreatedAt=0;for(var key in posts){var post=posts[key];if(post&&!post.importedByUrl&&post.createdAt>newestCreatedAt){newestCreatedAt=post.createdAt;finalPostId=post.id}}var numFetches=0;var maxFetches=10;var finalPostWasReached=false;var afterRedditPostId=void 0;function fetchMore(){return!finalPostWasReached&&numFetches<maxFetches}var totalData=[];function fetchPosts(callback){reddit.new(subreddit).limit(100).after(afterRedditPostId).fetch(function(json){var moreData=json.data.children.filter(function(post){return!post.data.stickied});moreData=moreData.map(function(post){var _post$data=post.data,title=_post$data.title,url=_post$data.url,created_utc=_post$data.created_utc,score=_post$data.score,author=_post$data.author,id=_post$data.id;return{title:title,url:url,createdAt:created_utc,score:score,author:author,id:id}});var finalPostIndex=void 0;var finalPost=moreData.find(function(post,index){finalPostIndex=index;return post.id===finalPostId});if(finalPost){finalPostWasReached=true;moreData.splice(finalPostIndex);totalData=totalData.concat(moreData);if(totalData.length<=1){return callback({code:"NoNewPosts",message:"The newest post in the database matched the newest post on reddit"})}return callback()}else{totalData=totalData.concat(moreData);numFetches++;if(!fetchMore()){return callback({code:"FinalPostNotFound",message:"finalPostId was not seen during the data fetching, maybe the post was deleted."})}}if(!moreData[moreData.length-1]){return callback({code:"NoMorePosts",message:"The oldest post on the subreddit was reached without seeing the finalPost"})}afterRedditPostId="t3_"+moreData[moreData.length-1].id})}function finalPostReached(err){if(err){reject(err);return}var fetchData={newestPost:totalData[0],updatedAt:Date.now()};fireRef.child("fetch").set(fetchData);totalData.forEach(function(post){var selftext=post.selftext,id=post.id;delete post.selftext;var postMeta=Object.assign({hidden:false,marked:false},post)});resolve(totalData)}async.whilst(fetchMore,fetchPosts,finalPostReached)}).catch(function(err){console.error("error in the newPostsFetcher",err)})})};"use strict";if(!Array.prototype.find){Object.defineProperty(Array.prototype,"find",{value:function value(predicate){if(this==null){throw new TypeError('"this" is null or not defined')}var o=Object(this);var len=o.length>>>0;if(typeof predicate!=="function"){throw new TypeError("predicate must be a function")}var thisArg=arguments[1];var k=0;while(k<len){var kValue=o[k];if(predicate.call(thisArg,kValue,k,o)){return kValue}k++}return undefined}})}"use strict";if(typeof Object.assign!="function"){Object.assign=function(target,varArgs){"use strict";if(target==null){throw new TypeError("Cannot convert undefined or null to object")}var to=Object(target);for(var index=1;index<arguments.length;index++){var nextSource=arguments[index];if(nextSource!=null){for(var nextKey in nextSource){if(Object.prototype.hasOwnProperty.call(nextSource,nextKey)){to[nextKey]=nextSource[nextKey]}}}}return to}}
//# sourceMappingURL=bundle.map